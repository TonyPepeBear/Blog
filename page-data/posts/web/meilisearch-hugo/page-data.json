{"componentChunkName":"component---src-templates-article-template-tsx","path":"/posts/web/meilisearch-hugo","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"id":"8e495473-8d57-530c-bb3f-4262fce2dde7","html":"<p>說到搜尋的解決方案，最有名的大概就是 <a href=\"https://www.algolia.com/\">Algolia</a>，可以方便的創建索引，也有很多寫好的前端網頁元件可以使用，唯一的缺點就是收費。雖然 Algolia 要收費，但其實對於我這個小網頁都索引量是完全不用錢的，但是就還是覺得自己架一個索引系統比較有感覺，然後我就在 GitHub 上發現了開源的 <a href=\"https://meilisearch.com\">MeiliSearch</a>，功能基本上跟 Algolia 很像，也支援中文，甚至有些前端元件可以直接使用 Algolia 的，缺點就是要自己架設 Server。</p>\n<!--more-->\n<p>本文以搜尋本站為目的撰寫，所以後面的範例大多與 Hugo 相關，如果想要看完整的程式碼，可以直接到本站的 GitHub。</p>\n<h2>簡介 MeiliSearch Server</h2>\n<p><img src=\"https://imagedelivery.net/cdkaXPuFls5qlrh3GM4hfA/f93885e8-f670-44ec-ea24-264a97c9a500/public\" alt=\"img\"></p>\n<p>基本上 MeiliSearch 就是一個 RESTful API，目標是要提供現成的搜尋解決方案，完全開源，提供即時搜尋、拼寫錯誤、同義詞、模糊搜尋、自訂排名、排序和多語言搜尋的支援，連中文也不例外。根據官方文件的介紹，MeiliSearch 以易用性為首要目標，對於開發者，只需要少少幾行 code 就可以使用；對於使用者，提供直觀的即時輸入即時反應的搜尋結果。</p>\n<p>官方也有很多的 SDK，.NET, Dart, Go, Java, JS, Python, Swift，而且上面這些還不是全部，所以在開發各語言的應用程式時，都可以考慮用 MeiliSearch 做為後端搜尋引擎。</p>\n<p>MeiliSearch 也不是完全沒有缺點，缺點就是要自己有伺服器，像是本文今天的案例就是要幫 Static Site 做搜尋的功能，通常 Static Site 大家應該都是用 GitHub Pages 等 Statice Site Hosting 服務，所以網頁本身是沒有自己架 Server 的，為了加個搜尋功能會要多一個 Server 就是很大的缺點。</p>\n<h2>SearchIndex.json</h2>\n<p>在開始使用 MeiliSearch 之前，我們先來把要索引的資料準備好，MeiliSearch 會需要使用 json 當作索引，所以我們要產生一個 json 的範本。創建 <code class=\"language-text\">/layouts/list.searchindex.json</code>，內容如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[ {{- $i := 0 -}}\n    {{- range where .Site.RegularPages \"Section\" \"ne\" \"\" -}}\n       {{- if not .Params.noSearch -}}\n          {{- if gt $i 0 }},{{ end -}}\n          {\"id\":{{ $i }}, \"date\":\"{{ .Date.Unix }}\", \"url\":\"{{ .Permalink }}\", \"title\":{{ .Title | jsonify  }}, \"summary\":{{ with .Description}}{{ . | plainify | jsonify }}{{ else }}{{ .Summary | plainify | jsonify }}{{ end }}, \"content\":{{ .Content | plainify | jsonify }},\"tags\":[ {{- $t := 0 }}{{- range .Param \"tags\" -}}{{ if gt $t 0 }},{{ end }}{{ . | jsonify }}{{ $t = add $t 1 }}{{ end -}} ], \"section\": {{ .Section | jsonify -}} }\n        {{- $i = add $i 1 -}}\n    {{- end -}}\n{{- end -}} ]</code></pre></div>\n<p>然後在 <code class=\"language-text\">config.yaml</code> 中加入下面的設定值：</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">outputFormats</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">SearchIndex</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">mediaType</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"application/json\"</span>\n    <span class=\"token key atrule\">baseName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"searchindex\"</span>\n    <span class=\"token key atrule\">isPlainText</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">notAlternative</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n<span class=\"token key atrule\">outputs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">home</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"HTML\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"RSS\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"SearchIndex\"</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>完成上面兩樣設定後，可以 <code class=\"language-text\">hugo</code> 一下試試看，有沒有在 <code class=\"language-text\">/public/searchindex.json</code> 中看到索引檔案，應該會類似如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"date\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1622891718\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"url\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://tonypepe.com/posts/others/hello-world/\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"title\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Hello World\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"summary\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Hello World. This is a test post.\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"content\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"This is my first post in hugo\\ncontent\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"tags\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"hugo\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"test\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"section\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"posts\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<h2>架設 MeiliSearch Server</h2>\n<p>準備好索引檔案後，我們就來架設 MeiliSearch 的 Server，MeiliSearch 是用 Rust 編寫，所以也是跨平台通用。官方提供很多種安裝方式，還有一鍵啟動腳本，當然，為了避免弄髒環境，最推薦的當然還是 Docker，下面就先以 Docker 為範例：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run -it --rm <span class=\"token punctuation\">\\</span>\n    -p <span class=\"token number\">7700</span>:7700 <span class=\"token punctuation\">\\</span>\n    -v <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">pwd</span><span class=\"token variable\">)</span></span>/data.ms:/data.ms <span class=\"token punctuation\">\\</span>\n    getmeili/meilisearch:latest</code></pre></div>\n<p>注意一下，上面掛載了一個 <code class=\"language-text\">data.ms</code> 的資料夾，所以在執行上面的指令前，記得先創建好。<code class=\"language-text\">data.ms</code> 這個資料夾是為了存放索引資料，避免因為 Docker 容器重啟就損失資料，所以很重要。</p>\n<p>現在可以到 <a href=\"http://localhost:7700\">http://localhost:7700</a>，會看到有一個簡易的 WEB UI。</p>\n<p><img src=\"https://imagedelivery.net/cdkaXPuFls5qlrh3GM4hfA/5664dc51-5d55-415a-3633-ac45e17d7a00/public\" alt=\"img\"></p>\n<p>如果不想用 Docker，還是可以參考官方文件的其他安裝方式安裝。</p>\n<h2>提交索引資料</h2>\n<p>前面有提到 MeiliSearch 是 RESTful API，所以要向他搜尋或是提供資料，都是用 HTTP Method。官方文件寫的都是 curl，我們還是使用 GUI 的方式介紹。HTTP 的 GUI 大家應該都會想到 Postman，但今天我們要使用他的開源替代 <a href=\"https://hoppspot.io\">Hoppsotch</a>，他是一個網頁工具，所以不需要安裝。</p>\n<p>可以先對 <code class=\"language-text\">/health</code> 做 <code class=\"language-text\">GET</code> 試試看有沒有連上，如果沒有連上，可能要檢查一下有沒有成功啟動 MeiliSearch Server。</p>\n<p><img src=\"https://imagedelivery.net/cdkaXPuFls5qlrh3GM4hfA/cf86e106-a1f6-472e-d2c1-a6b186944f00/public\" alt=\"img\"></p>\n<p>確定連上後，我們就來提交索引資料，如果還沒有 Hugo 產生的索引資料，可以先到本站的 GitHub，拿本站的 <a href=\"https://github.com/TonyPepeBear/HugoBlog/blob/1bfae9859a44338d24a9f6676be37f72cc983505/searchindex.json\">searchindex.json</a> 做測試。</p>\n<p>因為 MeiliSearch 也可以同時有多個 Indexes 做搜尋，我們下面的範例以 <code class=\"language-text\">hugo_blog</code> 作為範例名稱，大家可以根據需求自己決定使用的名稱。</p>\n<p><img src=\"https://imagedelivery.net/cdkaXPuFls5qlrh3GM4hfA/71797a57-6f97-44cd-f4dc-675ec42ffd00/public\" alt=\"img\"></p>\n<p>可以看到上圖對 <code class=\"language-text\">/indexes/&lt;&lt;IndexName>>/documents</code> 做 <code class=\"language-text\">POST</code> 方法，就可以把索引資料提交到 MeiliSearch Server。記得內容類型是 <code class=\"language-text\">application/json</code>，然後把索引資料放到 body。</p>\n<p>現在回到 <a href=\"http://localhost:7700\">localhost:7700</a>，應該就可以看到原本空空如也的 WEB UI 現在可以做搜尋了，可以先在這裡做一些簡單的搜尋，試試看自己的索引資料有沒有被成功的使用。</p>\n<p><img src=\"https://imagedelivery.net/cdkaXPuFls5qlrh3GM4hfA/c58970b0-53b5-4a16-50bb-ff40fa6fde00/public\" alt=\"img\"></p>\n<h2>MeiliSearch in Production</h2>\n<p>MeiliSearch 預設的啟動方式其實是 <code class=\"language-text\">development</code>，這模式只是方便本地做測試使用的，如果要使用在生產環境，應該要以 <code class=\"language-text\">production</code> 模式啟動。在 Production 模式下，會有兩個不一樣的地方，第一項是 Web UI 會被停用，第二項是會必須要設定 <code class=\"language-text\">Master Key</code>，下面還是用 Docker 作為範例：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run -it --rm <span class=\"token punctuation\">\\</span>\n    -p <span class=\"token number\">7700</span>:7700 <span class=\"token punctuation\">\\</span>\n    -v <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">pwd</span><span class=\"token variable\">)</span></span>/data.ms:/data.ms <span class=\"token punctuation\">\\</span>\n    -e <span class=\"token assign-left variable\">MEILI_ENV</span><span class=\"token operator\">=</span>production <span class=\"token punctuation\">\\</span>\n    -e <span class=\"token assign-left variable\">MEILI_MASTER_KEY</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>Your Master Key<span class=\"token operator\">></span> <span class=\"token punctuation\">\\</span>\n    getmeili/meilisearch:latest</code></pre></div>\n<p>上面設定的 Master Key，就是管理權限最大的 API Key，所以要記得妥善保存。</p>\n<p>下面用剛剛的 Master Key 去對 <code class=\"language-text\">/keys</code> 做 <code class=\"language-text\">GET</code>，然後在 Headers 中，加上剛剛的 Master Key，就可以拿到預設的搜尋 KEY，和預設的 ADMIN KEY。如果要再另外新增 API KEY，可以參考官方的文件，這裡就不多著墨。</p>\n<p><img src=\"https://imagedelivery.net/cdkaXPuFls5qlrh3GM4hfA/91af11f7-29fc-446b-7ae1-dcb47f82b900/public\" alt=\"img\"></p>\n<h2>為網頁加上搜尋功能</h2>\n<p>我們會用到 MeiliSearch 提供的 <a href=\"https://github.com/meilisearch/instant-meilisearch\">Instant MeiliSearch</a>，這個 JS 庫就是使用 Algolia 的 Instant Search 改的，所以有些文件可以直接去看 Algolia 的官方文件。Instant MeiliSearch 最簡單的使用方式也是直接用 CDN 的方式，下面是一個最簡單的模板，看懂後用類似的邏輯加到自己的網頁中就好。</p>\n<p>html:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">lang</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>en<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>utf-8<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>searchbox<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hits<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://cdn.jsdelivr.net/npm/@meilisearch/instant-meilisearch/dist/instant-meilisearch.umd.min.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://cdn.jsdelivr.net/npm/instantsearch.js@4<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>./app.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>下面是剛剛的 html 會用到的 <code class=\"language-text\">app.js</code>，用來作為 Search 的設定值，只要把下面的網址設定成自己的網址，和自己在前幾步驟拿到的搜尋 API KEY 就可以使用了：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> search <span class=\"token operator\">=</span> <span class=\"token function\">instantsearch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">indexName</span><span class=\"token operator\">:</span> <span class=\"token string\">\"steam-video-games\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">searchClient</span><span class=\"token operator\">:</span> <span class=\"token function\">instantMeiliSearch</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"https://integration-demos.meilisearch.com\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"q7QHwGiX841a509c8b05ef29e55f2d94c02c00635f729ccf097a734cbdf7961530f47c47\"</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nsearch<span class=\"token punctuation\">.</span><span class=\"token function\">addWidgets</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n  instantsearch<span class=\"token punctuation\">.</span>widgets<span class=\"token punctuation\">.</span><span class=\"token function\">searchBox</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">container</span><span class=\"token operator\">:</span> <span class=\"token string\">\"#searchbox\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  instantsearch<span class=\"token punctuation\">.</span>widgets<span class=\"token punctuation\">.</span><span class=\"token function\">hits</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">container</span><span class=\"token operator\">:</span> <span class=\"token string\">\"#hits\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">templates</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">item</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n        &lt;div>\n          &lt;div class=\"hit-name\">\n            {{#helpers.highlight}}{ \"attribute\": \"name\" }{{/helpers.highlight}}\n          &lt;/div>\n        &lt;/div>\n      </span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nsearch<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>如果覺得他預設提供的 UI 很醜，可以用 CSS 的方式去改他。</p>\n<h2>GitHub Actions 自動提交索引</h2>\n<p>不廢話，直接上本站的 yml:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> MeiliSearch Index\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> master <span class=\"token comment\"># Set a branch to deploy</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span><span class=\"token number\">20.04</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">submodules</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span> <span class=\"token comment\"># Fetch Hugo themes (true OR recursive)</span>\n          <span class=\"token key atrule\">fetch-depth</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span> <span class=\"token comment\"># Fetch all history for .GitInfo and .Lastmod</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Setup Node\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"14\"</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Setup Hugo\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> peaceiris/actions<span class=\"token punctuation\">-</span>hugo@v2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">hugo-version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"latest\"</span>\n          <span class=\"token key atrule\">extended</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          npm i\n          hugo --minify</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Post Index\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          curl \\\n            -X POST \"https://search.tonypepe.com/indexes/hugo_blog/documents\" \\\n            -H 'Authorization: Bearer ${{ secrets.MEILISEARCH_KEY }}' \\\n            -H 'Content-Type: application/json' \\\n            --data-binary \"@public/searchindex.json\"</span></code></pre></div>\n<p>其實重點就是在最後一步，把索引檔案 POST 到 MeiliSearch 就可以了。</p>\n<h2>Referenc</h2>\n<ul>\n<li><a href=\"https://meilisearch.com\">MeiliSearch</a></li>\n<li><a href=\"https://discourse.gohugo.io/t/a-simple-javascript-based-full-text-search-function/29119\">A simple javascript based full text search function</a></li>\n<li><a href=\"https://hoppspot.io\">Hoppsotch</a></li>\n<li><a href=\"https://github.com/meilisearch/instant-meilisearch\">Instant MeiliSearch</a></li>\n</ul>","rawMarkdownBody":"\n說到搜尋的解決方案，最有名的大概就是 [Algolia](https://www.algolia.com/)，可以方便的創建索引，也有很多寫好的前端網頁元件可以使用，唯一的缺點就是收費。雖然 Algolia 要收費，但其實對於我這個小網頁都索引量是完全不用錢的，但是就還是覺得自己架一個索引系統比較有感覺，然後我就在 GitHub 上發現了開源的 [MeiliSearch](https://meilisearch.com)，功能基本上跟 Algolia 很像，也支援中文，甚至有些前端元件可以直接使用 Algolia 的，缺點就是要自己架設 Server。\n\n<!--more-->\n\n本文以搜尋本站為目的撰寫，所以後面的範例大多與 Hugo 相關，如果想要看完整的程式碼，可以直接到本站的 GitHub。\n\n## 簡介 MeiliSearch Server\n\n![img](https://imagedelivery.net/cdkaXPuFls5qlrh3GM4hfA/f93885e8-f670-44ec-ea24-264a97c9a500/public)\n\n基本上 MeiliSearch 就是一個 RESTful API，目標是要提供現成的搜尋解決方案，完全開源，提供即時搜尋、拼寫錯誤、同義詞、模糊搜尋、自訂排名、排序和多語言搜尋的支援，連中文也不例外。根據官方文件的介紹，MeiliSearch 以易用性為首要目標，對於開發者，只需要少少幾行 code 就可以使用；對於使用者，提供直觀的即時輸入即時反應的搜尋結果。\n\n官方也有很多的 SDK，.NET, Dart, Go, Java, JS, Python, Swift，而且上面這些還不是全部，所以在開發各語言的應用程式時，都可以考慮用 MeiliSearch 做為後端搜尋引擎。\n\nMeiliSearch 也不是完全沒有缺點，缺點就是要自己有伺服器，像是本文今天的案例就是要幫 Static Site 做搜尋的功能，通常 Static Site 大家應該都是用 GitHub Pages 等 Statice Site Hosting 服務，所以網頁本身是沒有自己架 Server 的，為了加個搜尋功能會要多一個 Server 就是很大的缺點。\n\n## SearchIndex.json\n\n在開始使用 MeiliSearch 之前，我們先來把要索引的資料準備好，MeiliSearch 會需要使用 json 當作索引，所以我們要產生一個 json 的範本。創建 `/layouts/list.searchindex.json`，內容如下：\n\n```text\n[ {{- $i := 0 -}}\n    {{- range where .Site.RegularPages \"Section\" \"ne\" \"\" -}}\n       {{- if not .Params.noSearch -}}\n          {{- if gt $i 0 }},{{ end -}}\n          {\"id\":{{ $i }}, \"date\":\"{{ .Date.Unix }}\", \"url\":\"{{ .Permalink }}\", \"title\":{{ .Title | jsonify  }}, \"summary\":{{ with .Description}}{{ . | plainify | jsonify }}{{ else }}{{ .Summary | plainify | jsonify }}{{ end }}, \"content\":{{ .Content | plainify | jsonify }},\"tags\":[ {{- $t := 0 }}{{- range .Param \"tags\" -}}{{ if gt $t 0 }},{{ end }}{{ . | jsonify }}{{ $t = add $t 1 }}{{ end -}} ], \"section\": {{ .Section | jsonify -}} }\n        {{- $i = add $i 1 -}}\n    {{- end -}}\n{{- end -}} ]\n```\n\n然後在 `config.yaml` 中加入下面的設定值：\n\n```yaml\noutputFormats:\n  SearchIndex:\n    mediaType: \"application/json\"\n    baseName: \"searchindex\"\n    isPlainText: true\n    notAlternative: true\noutputs:\n  home: [\"HTML\", \"RSS\", \"SearchIndex\"]\n```\n\n完成上面兩樣設定後，可以 `hugo` 一下試試看，有沒有在 `/public/searchindex.json` 中看到索引檔案，應該會類似如下：\n\n```json\n[\n  {\n    \"id\": 0,\n    \"date\": \"1622891718\",\n    \"url\": \"https://tonypepe.com/posts/others/hello-world/\",\n    \"title\": \"Hello World\",\n    \"summary\": \"Hello World. This is a test post.\",\n    \"content\": \"This is my first post in hugo\\ncontent\",\n    \"tags\": [\"hugo\", \"test\"],\n    \"section\": \"posts\"\n  }\n]\n```\n\n## 架設 MeiliSearch Server\n\n準備好索引檔案後，我們就來架設 MeiliSearch 的 Server，MeiliSearch 是用 Rust 編寫，所以也是跨平台通用。官方提供很多種安裝方式，還有一鍵啟動腳本，當然，為了避免弄髒環境，最推薦的當然還是 Docker，下面就先以 Docker 為範例：\n\n```bash\ndocker run -it --rm \\\n    -p 7700:7700 \\\n    -v $(pwd)/data.ms:/data.ms \\\n    getmeili/meilisearch:latest\n```\n\n注意一下，上面掛載了一個 `data.ms` 的資料夾，所以在執行上面的指令前，記得先創建好。`data.ms` 這個資料夾是為了存放索引資料，避免因為 Docker 容器重啟就損失資料，所以很重要。\n\n現在可以到 [http://localhost:7700](http://localhost:7700)，會看到有一個簡易的 WEB UI。\n\n![img](https://imagedelivery.net/cdkaXPuFls5qlrh3GM4hfA/5664dc51-5d55-415a-3633-ac45e17d7a00/public)\n\n如果不想用 Docker，還是可以參考官方文件的其他安裝方式安裝。\n\n## 提交索引資料\n\n前面有提到 MeiliSearch 是 RESTful API，所以要向他搜尋或是提供資料，都是用 HTTP Method。官方文件寫的都是 curl，我們還是使用 GUI 的方式介紹。HTTP 的 GUI 大家應該都會想到 Postman，但今天我們要使用他的開源替代 [Hoppsotch](https://hoppspot.io)，他是一個網頁工具，所以不需要安裝。\n\n可以先對 `/health` 做 `GET` 試試看有沒有連上，如果沒有連上，可能要檢查一下有沒有成功啟動 MeiliSearch Server。\n\n![img](https://imagedelivery.net/cdkaXPuFls5qlrh3GM4hfA/cf86e106-a1f6-472e-d2c1-a6b186944f00/public)\n\n確定連上後，我們就來提交索引資料，如果還沒有 Hugo 產生的索引資料，可以先到本站的 GitHub，拿本站的 [searchindex.json](https://github.com/TonyPepeBear/HugoBlog/blob/1bfae9859a44338d24a9f6676be37f72cc983505/searchindex.json) 做測試。\n\n因為 MeiliSearch 也可以同時有多個 Indexes 做搜尋，我們下面的範例以 `hugo_blog` 作為範例名稱，大家可以根據需求自己決定使用的名稱。\n\n![img](https://imagedelivery.net/cdkaXPuFls5qlrh3GM4hfA/71797a57-6f97-44cd-f4dc-675ec42ffd00/public)\n\n可以看到上圖對 `/indexes/<<IndexName>>/documents` 做 `POST` 方法，就可以把索引資料提交到 MeiliSearch Server。記得內容類型是 `application/json`，然後把索引資料放到 body。\n\n現在回到 [localhost:7700](http://localhost:7700)，應該就可以看到原本空空如也的 WEB UI 現在可以做搜尋了，可以先在這裡做一些簡單的搜尋，試試看自己的索引資料有沒有被成功的使用。\n\n![img](https://imagedelivery.net/cdkaXPuFls5qlrh3GM4hfA/c58970b0-53b5-4a16-50bb-ff40fa6fde00/public)\n\n## MeiliSearch in Production\n\nMeiliSearch 預設的啟動方式其實是 `development`，這模式只是方便本地做測試使用的，如果要使用在生產環境，應該要以 `production` 模式啟動。在 Production 模式下，會有兩個不一樣的地方，第一項是 Web UI 會被停用，第二項是會必須要設定 `Master Key`，下面還是用 Docker 作為範例：\n\n```bash\ndocker run -it --rm \\\n    -p 7700:7700 \\\n    -v $(pwd)/data.ms:/data.ms \\\n    -e MEILI_ENV=production \\\n    -e MEILI_MASTER_KEY=<Your Master Key> \\\n    getmeili/meilisearch:latest\n```\n\n上面設定的 Master Key，就是管理權限最大的 API Key，所以要記得妥善保存。\n\n下面用剛剛的 Master Key 去對 `/keys` 做 `GET`，然後在 Headers 中，加上剛剛的 Master Key，就可以拿到預設的搜尋 KEY，和預設的 ADMIN KEY。如果要再另外新增 API KEY，可以參考官方的文件，這裡就不多著墨。\n\n![img](https://imagedelivery.net/cdkaXPuFls5qlrh3GM4hfA/91af11f7-29fc-446b-7ae1-dcb47f82b900/public)\n\n## 為網頁加上搜尋功能\n\n我們會用到 MeiliSearch 提供的 [Instant MeiliSearch](https://github.com/meilisearch/instant-meilisearch)，這個 JS 庫就是使用 Algolia 的 Instant Search 改的，所以有些文件可以直接去看 Algolia 的官方文件。Instant MeiliSearch 最簡單的使用方式也是直接用 CDN 的方式，下面是一個最簡單的模板，看懂後用類似的邏輯加到自己的網頁中就好。\n\nhtml:\n\n```html\n<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"utf-8\" />\n  </head>\n\n  <body>\n    <div>\n      <div id=\"searchbox\"></div>\n      <div id=\"hits\"></div>\n    </div>\n\n    <script src=\"https://cdn.jsdelivr.net/npm/@meilisearch/instant-meilisearch/dist/instant-meilisearch.umd.min.js\"></script>\n    <script src=\"https://cdn.jsdelivr.net/npm/instantsearch.js@4\"></script>\n    <script src=\"./app.js\"></script>\n  </body>\n</html>\n```\n\n下面是剛剛的 html 會用到的 `app.js`，用來作為 Search 的設定值，只要把下面的網址設定成自己的網址，和自己在前幾步驟拿到的搜尋 API KEY 就可以使用了：\n\n```js\nconst search = instantsearch({\n  indexName: \"steam-video-games\",\n  searchClient: instantMeiliSearch(\n    \"https://integration-demos.meilisearch.com\",\n    \"q7QHwGiX841a509c8b05ef29e55f2d94c02c00635f729ccf097a734cbdf7961530f47c47\"\n  ),\n});\n\nsearch.addWidgets([\n  instantsearch.widgets.searchBox({\n    container: \"#searchbox\",\n  }),\n  instantsearch.widgets.hits({\n    container: \"#hits\",\n    templates: {\n      item: `\n        <div>\n          <div class=\"hit-name\">\n            {{#helpers.highlight}}{ \"attribute\": \"name\" }{{/helpers.highlight}}\n          </div>\n        </div>\n      `,\n    },\n  }),\n]);\n\nsearch.start();\n```\n\n如果覺得他預設提供的 UI 很醜，可以用 CSS 的方式去改他。\n\n## GitHub Actions 自動提交索引\n\n不廢話，直接上本站的 yml:\n\n```yml\nname: MeiliSearch Index\n\non:\n  push:\n    branches:\n      - master # Set a branch to deploy\n\njobs:\n  deploy:\n    runs-on: ubuntu-20.04\n    steps:\n      - uses: actions/checkout@v2\n        with:\n          submodules: true # Fetch Hugo themes (true OR recursive)\n          fetch-depth: 0 # Fetch all history for .GitInfo and .Lastmod\n\n      - name: Setup Node\n        uses: actions/setup-node@v2\n        with:\n          node-version: \"14\"\n\n      - name: Setup Hugo\n        uses: peaceiris/actions-hugo@v2\n        with:\n          hugo-version: \"latest\"\n          extended: true\n\n      - name: Build\n        run: |\n          npm i\n          hugo --minify\n\n      - name: Post Index\n        run: |\n          curl \\\n            -X POST \"https://search.tonypepe.com/indexes/hugo_blog/documents\" \\\n            -H 'Authorization: Bearer ${{ secrets.MEILISEARCH_KEY }}' \\\n            -H 'Content-Type: application/json' \\\n            --data-binary \"@public/searchindex.json\"\n```\n\n其實重點就是在最後一步，把索引檔案 POST 到 MeiliSearch 就可以了。\n\n## Referenc\n\n- [MeiliSearch](https://meilisearch.com)\n- [A simple javascript based full text search function](https://discourse.gohugo.io/t/a-simple-javascript-based-full-text-search-function/29119)\n- [Hoppsotch](https://hoppspot.io)\n- [Instant MeiliSearch](https://github.com/meilisearch/instant-meilisearch)\n","excerpt":"說到搜尋的解決方案，最有名的大概就是 Algolia，可以方便的創建索引，也有很多寫好的前端網頁元件可以使用，唯一的缺點就是收費。雖然 Algolia 要收費，但其實對於我這個小網頁都索引量是完全不用錢的，但是就還是覺得自己架一個索引系統比較有感覺，然後我就在 GitHub 上發現了開源的 MeiliSearch，功能基本上跟 Algolia 很像，也支援中文，甚至有些前端元件可以直接使用 Al…","frontmatter":{"title":"MeiliSearch with Hugo","date":"2022-01-17T17:40:09.000Z","draft":false,"tags":["meilisearch","search","web","hugo","github","actions"],"image":"https://imagedelivery.net/cdkaXPuFls5qlrh3GM4hfA/f9f8be53-5393-4190-b6da-baf27d8a7500/public","description":null}}}]}},"pageContext":{"id":"8e495473-8d57-530c-bb3f-4262fce2dde7"}},"staticQueryHashes":[]}