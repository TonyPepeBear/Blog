<!doctype html><html lang=zh-tw><head><meta http-equiv=content-type content="text/html" charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href="/HugoBlog/css/main.min.ec65659f16e27fb708381e54bb6c75962ea17bb015b43ce715b936fb92141460.css" integrity="sha256-7GVlnxbif7cIOB5Uu2x1li6he7AVtDznFbk2+5IUFGA="><title>Kotlin Coroutine - TonyPepe</title></head><body class=bg-gray-200><script src=https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js defer></script><div class="container mx-auto lg:flex"><aside class="lg:w-1/5 top-4 lg:sticky h-full z-0 mt-4"><nav class="mx-4 lg:mx-0 flex flex-row lg:flex-col xl:ml-28"><div><img class="rounded-full w-32 h-32 hover:-rotate-12 transform duration-700" src=https://imagedelivery.net/cdkaXPuFls5qlrh3GM4hfA/cfccf3e2-7fd5-4e6c-adcb-a3cc5064f900/public alt><div class=mt-3><a href=/ class="mt-10 text-2xl font-black text-gray-800">TonyPepe</a></div></div><div><div class="flex flex-col ml-4 lg:ml-0"><a href=/ class="mt-5 text-xl font-black text-gray-800 hover:text-blue-900"><div class="flex flex-row items-center"><span class=iconify data-icon=mdi:home></span><p class=ml-2>Home</p></div></a><a href=/search class="mt-5 text-xl font-black text-gray-800 hover:text-blue-900"><div class="flex flex-row items-center"><span class=iconify data-icon=mdi:file-search></span><p class=ml-2>Search</p></div></a><a href=/about class="mt-5 text-xl font-black text-gray-800 hover:text-blue-900 transition"><div class="flex flex-row items-center"><span class=iconify data-icon=mdi:human-greeting-variant></span><p class=ml-2>About</p></div></a></div></div></nav></aside><div class="lg:w-3/5 z-10 mt-12"><main><div class="bg-white shadow-md rounded-xl my-5 mx-2"><img src=https://imagedelivery.net/cdkaXPuFls5qlrh3GM4hfA/6f11a63e-3923-4ce5-3b6e-d06243815300/public class="filter w-full h-80 object-cover rounded-t-xl"><div class=px-3><h1 class="text-4xl my-5 inline-block text-center w-full text-black">Kotlin Coroutine</h1><div class="mx-2 flex flex-row pb-2 text-gray-500 items-center"><span class=iconify data-icon=mdi:calendar-range></span>
<time class=ml-1 datetime=2021-09-19T07:26:56Z>2021-Sep-19</time>
<a href=https://github.com/TonyPepeBear/HugoBlog/commit/ac97c4b38a90fbb53bd1841c78ff4f3e0348d9c1 target=_blank class="flex flex-row items-center ml-5"><span class=iconify data-icon=bi:git></span><p class=ml-1>ac97c4b</p></a><a href=https://github.com/TonyPepeBear/HugoBlog/issues target=_blank class="flex flex-row items-center ml-5"><span class=iconify data-icon=bi:info-circle-fill></span><p class=ml-1>Issue</p></a></div><article class="mx-2 pb-4 text-justify"><p>Kotlin 在非同步處理上有新的方法，協程 <code>Coroutine</code>。<code>Coroutine</code> 不會像 <code>Thread</code> 會耗費大量的資源，能在原本的<code>線程</code>上創建極為輕量的<code>協程</code>，且較不會發生記憶體洩漏的情況。</p><h2 id=導入-coroutine>導入 Coroutine</h2><p>在 <code>build.gradle</code> 中添加依賴項</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>dependencies <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    implementation <span style=color:#e6db74>&#39;org.jetbrains.kotlinx:kotlinx-coroutines-core:1.3.2&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>若要在 <code>Android</code> 中使用需要再添加 <code>Android</code> 依賴</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>implementation <span style=color:#e6db74>&#39;org.jetbrains.kotlinx:kotlinx-coroutines-android:1.3.2&#39;</span>
</span></span></code></pre></div><h2 id=第一個-coroutine>第一個 Coroutine</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>import</span> kotlinx.coroutines.*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    GlobalScope.launch { <span style=color:#75715e>//在後台啟動一個新的縣協程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        delay(<span style=color:#ae81ff>1000L</span>) <span style=color:#75715e>//非阻塞式的等待 1 秒鐘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        println(<span style=color:#e6db74>&#34;World!&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    println(<span style=color:#e6db74>&#34;Hello,&#34;</span>)
</span></span><span style=display:flex><span>    Thread.sleep(<span style=color:#ae81ff>2000L</span>) <span style=color:#75715e>// 阻塞主線程兩秒確保主線程存活
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>上面的程式碼輸出結果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>Hellow,
</span></span><span style=display:flex><span>World
</span></span></code></pre></div><p>基本上 <code>Coroutine</code> 就是輕量的協程</p><p>也可以分別將 <code>GlobalScope.launch{...}</code> 和 <code>delay(...)</code> 替換成<code>thread { ... }</code> 和 <code>Thread.Sleap(...)</code>，也可以得到相同的結果，可以嘗試一下。</p><p>如果只將 <code>GlobalScope.launch{...}</code> 替換成 <code>thread{...}</code> 你會得到以下錯誤：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Error: Kotlin: Suspend functions are only allowed to be called from a coroutine or another suspend <span style=color:#66d9ef>function</span>
</span></span></code></pre></div><p>因為 <code>delay()</code> 是一個特殊的 <code>suspend function</code> (有人譯作 <code>掛起函數</code>)，他不會阻塞線程，但是會 <code>suspend</code> 協程，而且只能在協程中使用。</p><h2 id=橋接阻塞和非阻塞的世界>橋接阻塞和非阻塞的世界</h2><p>上面的範例中同時使用了非阻塞式的 <code>delay()</code> 和阻塞式的 <code>Thread.sleap()</code>，這樣很容易讓我們混淆哪個會阻塞線程。下面我們使用 <code>runblocking{...}</code> 來阻塞線程</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>import</span> kotlinx.coroutines.*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    GlobalScope.launch { <span style=color:#75715e>// 在後台啟動一個新的協程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        delay(<span style=color:#ae81ff>1000L</span>)
</span></span><span style=display:flex><span>        println(<span style=color:#e6db74>&#34;World!&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    println(<span style=color:#e6db74>&#34;Hello,&#34;</span>)
</span></span><span style=display:flex><span>    runBlocking {     <span style=color:#75715e>// 這個表達式會阻塞主線程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        delay(<span style=color:#ae81ff>2000L</span>)  <span style=color:#75715e>// 延遲兩秒來確保主線程存活
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>結果基本上是相似的，只是都是使用了非組塞式的 <code>delay()</code>。調用了 <code>runblocking{...}</code> 的主線程會被阻塞直到 <code>runblocking{...}</code> 內的協程執行完畢。</p><p>下面用一個更合乎慣用法的方法在寫一次，用 <code>runblocking{...}</code> 來包裝 <code>main</code> 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>import</span> kotlinx.coroutines.*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>main</span>() = runBlocking&lt;Unit&gt; { <span style=color:#75715e>// 開始執行主協程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    GlobalScope.launch { <span style=color:#75715e>// 在後台啓動一個協程並繼續執行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        delay(<span style=color:#ae81ff>1000L</span>)
</span></span><span style=display:flex><span>        println(<span style=color:#e6db74>&#34;World!&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    println(<span style=color:#e6db74>&#34;Hello,&#34;</span>)
</span></span><span style=display:flex><span>    delay(<span style=color:#ae81ff>2000L</span>)  <span style=color:#75715e>// 延遲 2 秒來確保主線程存活
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>這裡的 <code>runBlocking {...}</code> 用來啟動主線程。我們顯式指定了其返回類型 <code>Unit</code>，因為在 Kotlin 中 <code>main</code> 方法必須回傳 <code>Unit</code>。</p><h2 id=等待一個作業完成>等待一個作業完成</h2><p>延遲一段時間來確保協程的運行並不是一個好辦法利用 <code>job.join()</code> 來確保工作執行結束。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>val</span> job: Job = GlobalScope.launch {
</span></span><span style=display:flex><span>    delay(<span style=color:#ae81ff>1000L</span>)
</span></span><span style=display:flex><span>    println(<span style=color:#e6db74>&#34;World!&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>println(<span style=color:#e6db74>&#34;Hello,&#34;</span>)
</span></span><span style=display:flex><span>job.join()
</span></span></code></pre></div><p><code>launch</code> 會回傳一個 <code>Job</code> 物件，而 <code>job.join()</code> 其實就是會等待 <code>job</code> 的工作完成再繼續持行。</p><p>我們也可以利用 <code>job.cancel()</code> 取消協程：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>val</span> job: Job = GlobalScope.launch {
</span></span><span style=display:flex><span>    delay(<span style=color:#ae81ff>1000L</span>)
</span></span><span style=display:flex><span>    println(<span style=color:#e6db74>&#34;World!&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>println(<span style=color:#e6db74>&#34;Hello,&#34;</span>)
</span></span><span style=display:flex><span>job.cancel()
</span></span></code></pre></div><p>但是如果 <code>job</code> 已經完成工作，<code>cancel</code> 是不會發生任何事。</p><h2 id=參考資料>參考資料</h2><ul><li><a href=https://kotlinlang.org/docs/reference/coroutines/basics.html>Coroutine Basics</a></li></ul></article></div></div><div class=py-2><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1667006488909532" crossorigin=anonymous></script>
<ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-1667006488909532 data-ad-slot=8852856882></ins>
<script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></main></div><aside class="lg:w-1/5 top-4 lg:sticky h-full z-0 mt-4 pl-3"><nav><div class="overflow-y-auto page-right-nav rounded-lg shadow-md bg-gray-50 my-10 p-3 mr-3" style=max-height:65vh><h2 class="text-3xl m-4 text-gray-600">目錄</h2><nav id=TableOfContents><ul><li><a href=#導入-coroutine>導入 Coroutine</a></li><li><a href=#第一個-coroutine>第一個 Coroutine</a></li><li><a href=#橋接阻塞和非阻塞的世界>橋接阻塞和非阻塞的世界</a></li><li><a href=#等待一個作業完成>等待一個作業完成</a></li><li><a href=#參考資料>參考資料</a></li></ul></nav></div></nav></aside></div><footer class="h-60 bg-gray-800 flex justify-center items-center flex-col space-y-8"><p class="order-1 text-gray-100">TonyPepe &copy; 2020 - 2022</p><div class="order-2 text-gray-100 inline-flex"><p>Made with</p><span class="iconify mx-2" data-icon=ant-design:heart-filled style=color:#f21111></span><p>and <a href=https://gohugo.io/ target=_blank>Hugo</a> in Taiwan</p></div><div class="order-3 flex flex-row space-x-6"><a href=https://github.com/TonyPepeBear/HugoBlog target=_blank><span class="iconify text-white" data-icon=file-icons:hugo data-width=33></span></a>
<a href=https://www.wikiwand.com/en/Taiwan target=_blank><span class=iconify data-icon=twemoji:flag-for-flag-taiwan style=color:#f21111 data-width=40></span></a>
<a href=https://github.com/TonyPepeBear target=_blank><span class="iconify text-white" data-icon=fontisto:github data-width=35></span></a></div></footer><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500&family=Noto+Serif+TC:wght@600&display=swap" rel=stylesheet><script src=https://code.iconify.design/2/2.1.0/iconify.min.js></script>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/base16/dracula.min.css><script data-cfasync=false src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js></script>
<script data-cfasync=false src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/languages/kotlin.min.js></script>
<script data-cfasync=false src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/languages/groovy.min.js></script>
<script data-cfasync=false src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/languages/dart.min.js></script>
<script data-cfasync=false src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/languages/dockerfile.min.js></script>
<script data-cfasync=false src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/languages/http.min.js></script>
<script defer>hljs.highlightAll()</script></body></html>