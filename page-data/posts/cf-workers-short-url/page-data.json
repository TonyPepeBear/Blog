{"componentChunkName":"component---src-templates-article-template-tsx","path":"/posts/cf-workers-short-url","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"id":"550f8597-f4a8-5fe3-a7ca-f1392da79702","html":"<p>Cloudflare Workers ä¹Ÿæ˜¯ Cloudflare çš„ä½›å¿ƒæœå‹™ä¹‹ä¸€ï¼Œå¯ä»¥æŠŠ node ç¨‹å¼éƒ¨ç½²åˆ° Cloudflare ä¸Šçš„çœ¾å¤šç¯€é»ï¼Œæ•ˆèƒ½ä¹Ÿä¸ä¿—ï¼Œæ¯å¤©é‚„æœ‰ 100,000 æ¬¡çš„å…è²»å‘¼å«ï¼Œä¹Ÿæ²’æœ‰å†·å•Ÿå‹•çš„å•é¡Œï¼Œå°æµé‡ä¸é«˜çš„ç¶²é ä¾†èªªå®Œå…¨å¤ ç”¨ã€‚å¦å¤–ï¼Œé‚„æœ‰ Workers KV å¯ä»¥ç”¨ä¾†å„²å­˜è³‡æ–™ï¼Œé€™å°±å¯ä»¥å¯«å‡ºç°¡å–®çš„å‹•æ…‹ç¶²é ï¼Œç”šè‡³æ˜¯ä¸€äº›æ›´è¤‡é›œçš„æ‡‰ç”¨ã€‚ä»Šå¤©å°±ä¾†å¯«ä¸€å€‹ Serverless çš„çŸ­ç¶²å€æœå‹™ï¼Œä¸¦æŠŠè³‡æ–™å­˜åœ¨ KV ä¸­ï¼Œå°±æˆ‘ç›®å‰è‡ªå·±æ¸¬è©¦ä¸‹ä¾†ï¼ŒWorkers çš„æ•ˆç‡çœŸçš„æ²’è©±èªªã€‚</p>\n<!--more-->\n<h2>Workers Playground</h2>\n<p>å¦‚æœæƒ³è¦åœ¨ç¶²é ä¸­å…ˆè©¦è©¦çœ‹ Workersï¼Œå¯ä»¥åˆ° <a href=\"https://cloudflareworkers.com/\">Cloudflare Workers</a> é€™å€‹ç¶²ç«™ã€‚</p>\n<p>æœƒæœ‰ä¸€å€‹é è¨­çš„æ¨¡æ¿é•·é€™æ¨£ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fetch\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  event<span class=\"token punctuation\">.</span><span class=\"token function\">respondWith</span><span class=\"token punctuation\">(</span><span class=\"token function\">handleRequest</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * Fetch and log a given request object\n * @param {Request} request\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handleRequest</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">request</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Got request\"</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Got response\"</span><span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>è®“æˆ‘å€‘å…ˆä¾†ç†è§£ä¸€ä¸‹ç¨‹å¼ç¢¼ã€‚</p>\n<p>å¯ä»¥çœ‹åˆ°ç¨‹å¼æœ‰å…©å€‹ functionï¼Œå…¶ä¸­ <code class=\"language-text\">addEventListener(...)</code> å°±æ˜¯ç¨‹å¼çš„å…¥å£ï¼Œç•¶ Workers æ”¶åˆ° Request ä¹‹å¾Œï¼Œå°±æœƒå‚³å…¥ä½ çµ¦ä»–çš„ functionï¼Œç„¶å¾Œå†æ±ºå®šè¦ç”¨ä»€éº¼ Response å›å‚³åˆ° Clientï¼Œé€™è£¡ä»–å¯«äº†ä¸€å€‹ <code class=\"language-text\">handleRequest</code> çš„ function ä¾†è™•ç†ã€‚æ‰€ä»¥é€™å€‹ç¨‹å¼ç¢¼å¯¦éš›ä¸Šåšçš„äº‹ï¼Œå°±åªæœ‰æŠŠ Request å’Œ Response çµ¦ log å‡ºä¾†ï¼Œå›å‚³åŸæœ¬çš„ç¶²é çš„æ¨£å­ä¸åšä»»ä½•æ›´å‹•ã€‚</p>\n<p>ä¸‹åœ–æ˜¯ Workers åœ¨ Cloudflare ä¸Šçš„é‹è¡Œé †åºï¼Œå¯ä»¥çœ‹åˆ° Workers è¢«æ”¾åœ¨æœ€å¾Œä¸€å€‹ï¼Œä¹Ÿå°±æ˜¯æœ€å¾Œä¸€å€‹æ±ºå®šè¦å›å‚³ä»€éº¼å…§å®¹çµ¦ User çš„åœ°æ–¹ï¼Œä¹Ÿå¯ä»¥ç†è§£ç‚ºå¯ä»¥åœ¨é€™è£¡å°åŸæœ¬çš„ Response åšæœ€å¾Œçš„æ›´å‹•ï¼Œå†å›å‚³çµ¦ Clientã€‚</p>\n<p>æ‰€ä»¥é€™å€‹ Playground ä¸Šå¯ä»¥è¼¸å…¥ä»»æ„çš„ URLï¼Œä¾†é è¦½ä½ çš„ Workers åœ¨ä»»ä½•ä¸€å€‹ç¶²ç«™ä¸Šï¼Œæœƒå° Response åšçš„æ›´å‹•ã€‚</p>\n<p><img src=\"https://imagedelivery.net/cdkaXPuFls5qlrh3GM4hfA/32bd1508-ba78-4e94-76a0-adec503fe000/public\" alt=\"img\"></p>\n<p>ä¹Ÿå°±æ˜¯èªªå¦‚æœæŠŠç¨‹å¼æ”¹æˆä¸‹é¢é€™æ¨£ï¼Œå°±å¯ä»¥ç™¼ç¾ä»»æ„ç¶²ç«™éƒ½æœƒè®Šæˆ Google çš„æ¨¡æ¨£ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fetch\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  event<span class=\"token punctuation\">.</span><span class=\"token function\">respondWith</span><span class=\"token punctuation\">(</span><span class=\"token function\">handleRequest</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handleRequest</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">request</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://google.com\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><img src=\"https://imagedelivery.net/cdkaXPuFls5qlrh3GM4hfA/d7409a8b-8203-4e23-6491-309a4cc5b500/public\" alt=\"img\"></p>\n<p>ç†è§£å¾Œå°±æœƒç™¼ç¾ï¼Œå…¶å¯¦ Workers å¯ä»¥å°ç¶²é æœ‰å³æ™‚æ€§çš„æ›´æ”¹ï¼Œä¹Ÿå°±æ˜¯èªªå¯ä»¥å°ç¾æœ‰çš„ç¶²é åŠ ä¸Šæ–°åŠŸèƒ½ï¼Œæˆ–æ˜¯åœ¨ä¸æ›´å‹•åŸæœ¬ç¶²é çš„æƒ…æ³ä¸‹å»ä¿® bugã€‚</p>\n<h2>Wrangler</h2>\n<p>Wrangler æ˜¯ç®¡ç† Workers æœƒç”¨åˆ°çš„ cli å·¥å…·ï¼Œé›–ç„¶ä¸å®‰è£ä¹Ÿæ˜¯å¯ä»¥åœ¨ç¶²é ä¸­æ’°å¯« Workers ï¼Œä½†æ˜¯åŠŸèƒ½å°±æœƒå°‘å¾ˆå¤šï¼Œæ‰€ä»¥é‚„æ˜¯å»ºè­°å®‰è£ä¸€ä¸‹ã€‚é€™è£¡æ˜¯å®˜æ–¹çš„ Repo <a href=\"https://github.com/cloudflare/wrangler2\">cloudflare/wrangler2</a>ã€‚</p>\n<p>ç”¨ npm å®‰è£åˆ° Globalï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> i @cloudflare/wrangler -g</code></pre></div>\n<p>é‚„æ˜¯å»ºè­°å»å®˜æ–¹ Repo çœ‹ä¸‹æœ‰æ²’æœ‰å…¶ä»–æ³¨æ„äº‹é …</p>\n<p>å®‰è£å®Œæˆå¾Œè¦ç™»å…¥ Cloudflare å¸³è™Ÿï¼Œ<code class=\"language-text\">wrangler login</code>ï¼Œå†ç”¨ç€è¦½å™¨ç™»å…¥å³å¯ã€‚</p>\n<h2>Init Project</h2>\n<p><code class=\"language-text\">wrangler init &lt;project-name></code> å‰µå»ºæ–°çš„å°ˆæ¡ˆï¼Œé€™ç•¶ä¸­ Wrangler æœƒå•ä¸€äº›å•é¡Œï¼Œå¯ä»¥æŒ‰ç…§è‡ªå·±çš„éœ€æ±‚æ±ºå®šã€‚</p>\n<p>init å®Œæˆå¾Œï¼Œå¯ä»¥çœ‹åˆ°è‡ªå‹•ç”¢ç”Ÿäº†ä¸€äº›æª”æ¡ˆï¼ŒåŸºæœ¬ä¸Šæœƒç”¨åˆ°çš„åªæœ‰ <code class=\"language-text\">wrangler.toml</code> å’Œ <code class=\"language-text\">index.js</code> å…©å€‹æª”æ¡ˆã€‚</p>\n<p>ç¾åœ¨å¯ä»¥å…ˆåœ¨ Terminal ä¸­è¼¸å…¥ <code class=\"language-text\">wrangler dev</code>ï¼Œå°±å¯ä»¥è®“ Workers è·‘åœ¨æœ¬åœ°ã€‚</p>\n<h3>Bug</h3>\n<p>å› ç‚ºæˆ‘çš„ Cloudflare ä¸€æ¬¡ç™»å…¥å¤šå€‹ Userï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ wrangler çš„ <strong>2.0.14</strong> æ™‚å€™æœƒå‡º bug ç›´æ¥é–ƒé€€ï¼Œæˆ‘è§£æ±ºçš„æ–¹å¼æ˜¯ç›´æ¥åœ¨ <code class=\"language-text\">wrangler.toml</code> ä¸­è¼¸å…¥ <code class=\"language-text\">account_id</code> ä¾†é¿å… wrangler æœƒéœ€è¦é¸æ“‡å¸³è™Ÿçš„å•é¡Œã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"toml\"><pre class=\"language-toml\"><code class=\"language-toml\"><span class=\"token key property\">account_id</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"xxxxxxxxxxxxxxx\"</span></code></pre></div>\n<h2>Cloudflare Workers KV</h2>\n<p>çœ‹åˆ°åå­—å–ä½œ KVï¼Œç›´è§€çš„å°±æ˜¯è¡¨ç¤º <code class=\"language-text\">key-value</code> éµå€¼å°ï¼Œç¼ºé»æ˜¯ Key åªèƒ½å°ä¸Šä¸€å€‹ Valueï¼Œä¸èƒ½è¦å·¢ç‹€çš„ Value (åƒæ˜¯ Json é‚£æ¨£)ï¼Œè§£æ±ºçš„æ–¹å¼å…¶å¯¦ä¹Ÿæ˜¯ä¸é›£ï¼Œå¯ä»¥ç›´æ¥åœ¨ Value ä¸­å­˜ä¸Šæ•´çš„ Json æª”æ¡ˆï¼Œä½†åœ¨æœ¬æ–‡ä¸æœƒå¤šåšèªªæ˜ï¼Œå¯ä»¥è‡ªå·±ç ”ç©¶çœ‹çœ‹ã€‚</p>\n<p>å¦å¤– Cloudflare ä¹Ÿæœ‰æåˆ°ï¼ŒKV å­˜å–åœ¨å…¨çƒå¯èƒ½ä¸æ˜¯å³æ™‚æ€§çš„ï¼Œå¥½åƒæ˜¯åªä¿è­‰ 60 ç§’å¾ŒæœƒåŒæ­¥åˆ°æ‰€æœ‰ Serverï¼Œé›–ç„¶æˆ‘è¦ºå¾—æœ€æ…¢æ‡‰è©²ä¹Ÿæ˜¯ 5 å…§ç§’å•¦ï¼Œæˆ‘å¾ä¾†æ²’æœ‰æ„Ÿå—åˆ°å»¶é²éï¼Œä½†å¦‚æœå°å³æ™‚æ€§æœ‰ç–‘æ…®çš„å°ˆæ¡ˆå¯èƒ½ä¹Ÿè¦æ³¨æ„ä¸€ä¸‹ã€‚</p>\n<p>ä¸‹é¢å°±ä¾†å‰µå»ºä¸€å€‹ KV namespaceï¼Œé€™å°±æ˜¯ä¸€å€‹ Database çš„åŸºæœ¬å–®ä½ï¼Œç›®å‰ Cloudflare æ˜¯å…è¨±ä¸€å€‹å¸³è™Ÿæœ‰ 100 å€‹ KV namespaceï¼Œæ‰€ä»¥æ­£å¸¸ä¾†èªªæ‡‰è©²ä¹Ÿä¸ç”¨æ“”å¿ƒæœƒç”¨å®Œã€‚ä¸‹é¢ç”¨ <code class=\"language-text\">URLS</code> ç•¶ä½œ namespace çš„åç¨±ï¼Œå› ç‚ºæˆ‘å€‘æ˜¯è¦å­˜çŸ­ç¶²å€çš„è³‡æ–™ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ wrangler kv:namespace create <span class=\"token string\">\"URLS\"</span>\n\nğŸŒ€  Creating namespace with title <span class=\"token string\">\"my-site-MY_KV\"</span>\nâœ¨  Success<span class=\"token operator\">!</span>\nAdd the following to your configuration file:\nkv_namespaces <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span> binding <span class=\"token operator\">=</span> <span class=\"token string\">\"URLS\"</span>, <span class=\"token function\">id</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"xxxxxxxxxxxxxxxxxxxxxxx\"</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>ç„¶å¾Œ wrangler æœƒæœ‰å€‹çµ¦ä½ ä¸€å€‹ binding å’Œ idï¼Œå°±ç›´æ¥è¤‡è£½è²¼ä¸Šåˆ° <code class=\"language-text\">wrangler.tmol</code> ä¸­å³å¯ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"toml\"><pre class=\"language-toml\"><code class=\"language-toml\"><span class=\"token key property\">kv_namespaces</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token key property\">binding</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"URLS\"</span><span class=\"token punctuation\">,</span> <span class=\"token key property\">id</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"xxxxxxxxxxxxxxxxxxxxxxx\"</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>å¦‚æœè¦åœ¨ wrangler çš„ dev æ¨¡å¼ä¸­æ¸¬è©¦ KVï¼Œå°±å¤šç”³è«‹ä¸€å€‹ Preview KVï¼Œä¾†é¿å…å°å·²ç¶“ä¸Šç·šçš„æœå‹™é€ æˆå½±éŸ¿ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ wrangler kv:namespace create <span class=\"token string\">\"URLS\"</span> --preview\n\nâ›…ï¸ wrangler <span class=\"token number\">2.0</span>.14\n--------------------\nğŸŒ€ Creating namespace with title <span class=\"token string\">\"URLS\"</span>\nâœ¨ Success<span class=\"token operator\">!</span>\nAdd the following to your configuration <span class=\"token function\">file</span> <span class=\"token keyword\">in</span> your kv_namespaces array:\n<span class=\"token punctuation\">{</span> binding <span class=\"token operator\">=</span> <span class=\"token string\">\"URLS\"</span>, preview_id <span class=\"token operator\">=</span> <span class=\"token string\">\"xxxxxxxxxxxxxxxxxxxx2\"</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>é€™æ¬¡æŠŠ <code class=\"language-text\">preview_id</code> å®¶åœ¨åŸæœ¬çš„ id å¾Œæ–¹å³å¯ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"toml\"><pre class=\"language-toml\"><code class=\"language-toml\"><span class=\"token key property\">kv_namespaces</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span> <span class=\"token key property\">binding</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"URLS\"</span><span class=\"token punctuation\">,</span> <span class=\"token key property\">id</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"xxxxxxxxxxxxxxxxxxxx\"</span><span class=\"token punctuation\">,</span> <span class=\"token key property\">preview_id</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"xxxxxxxxxxxxxxxxxxxx2\"</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>è¨­å®šå¥½å¾Œï¼Œwrangler æœƒç›´æ¥æŠŠä½ å‰›å‰›å–çš„åå­—ç›´æ¥ç”¨ç’°å¢ƒè®Šæ•¸ (ENV) å‚³å…¥ï¼Œå…·é«”çš„ä½¿ç”¨æ–¹å¼å¯ä»¥ç¹¼çºŒå¾€ä¸‹çœ‹ã€‚</p>\n<h2>Routing</h2>\n<p>ç‚ºäº†æ–¹ä¾¿ç­‰ç­‰æˆ‘å€‘è™•ç†å‚³å…¥çš„ Routingï¼Œæˆ‘å€‘å…ˆä¾†å®‰è£ä¸€å€‹ npm å¥—ä»¶ã€‚å°ä½ æ²’çœ‹éŒ¯ï¼ŒWorkers ä¹Ÿæ˜¯æ”¯æ´ npm å¥—ä»¶çš„ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">yarn</span> <span class=\"token function\">add</span> itty-router\n\n<span class=\"token function\">npm</span> i itty-router</code></pre></div>\n<p>é€™æ¨£ç­‰ç­‰å°±å¯ä»¥ç”¨ itty-router ä¾†è™•ç†å‚³å…¥çš„ requestã€‚</p>\n<p>æˆ‘å€‘å…ˆå°‡ Handle Request å®Œå…¨ä¸Ÿçµ¦çš„ itty-router ä¾†è™•ç†ï¼Œå°‡ index.js æ”¹æˆä¸‹æ–¹é€™æ¨£ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Router <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"itty-router\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token function\">Router</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">fetch</span><span class=\"token operator\">:</span> router<span class=\"token punctuation\">.</span>handle<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>å¯ä»¥çœ‹åˆ°ç›´æ¥ export router çš„ handle æ–¹æ³•ï¼Œé€™æ¨£å°±å®Œå…¨æŠŠ Requse äº¤çµ¦ Router ä¾†è™•ç†ã€‚æˆ‘å€‘å…ˆå°‡ root å›å‚³ Hello æ¸¬è©¦çœ‹çœ‹ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Router <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"itty-router\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token function\">Router</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> env</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Response</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello Workers\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">status</span><span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">fetch</span><span class=\"token operator\">:</span> router<span class=\"token punctuation\">.</span>handle<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>ç¾åœ¨å¯ä»¥ <code class=\"language-text\">wrangler dev</code> ä¸€ä¸‹ï¼Œç„¶å¾Œåˆ° <code class=\"language-text\">loclahost:8787/</code> çœ‹çœ‹æœƒä¸æœƒå›å‚³ Hello Workersã€‚</p>\n<blockquote>\n<p>ä¹‹å¾Œçš„ç¨‹å¼ç¢¼å°±ä¸å†å®Œæ•´çš„å¯«å‡ºä¾†äº†ï¼Œä½†å°±æ˜¯åœ¨é€™å€‹å¤§æ¡†æ¶ä¸‹æ’°å¯«</p>\n</blockquote>\n<h3>New çŸ­ç¶²å€</h3>\n<p>æˆ‘å€‘å¯«ä¸€å€‹ post æ–¹æ³•ä¾†æ¥æ”¶æ–°çš„ç¶²å€ï¼Œä¸¦å›å‚³ä»–çš„æ–°çŸ­ç¶²å€çµ¦ä»–ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">router<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/new\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> env</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> req<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\">// å–å¾— POST JSON BODY ä¸¦è½‰æˆ JS ç‰©ä»¶</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> <span class=\"token punctuation\">{</span> url<span class=\"token punctuation\">,</span> len <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> body<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>url <span class=\"token operator\">==</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token function\">f00</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// JSON æœ‰èª¤ï¼Œå›å‚³ 400 éŒ¯èª¤</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isValidHttpUrl</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token function\">f00</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"URL is not valid\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// ç¢ºèªæ˜¯å¦ç‚º Http ç¶²å€</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>len <span class=\"token operator\">==</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> len <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>len <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token function\">f00</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Lenght must be at least 4\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ç¢ºèªè‡³å°‘å¤§æ–¼ç­‰æ–¼ 4</span>\n  <span class=\"token keyword\">var</span> s <span class=\"token operator\">=</span> <span class=\"token function\">getRandomString</span><span class=\"token punctuation\">(</span>len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ç”¢ç”Ÿè‹±æ–‡äº‚ç¢¼</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> env<span class=\"token punctuation\">.</span><span class=\"token constant\">URLS</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// å¾ kv ç¢ºèªæ²’æœ‰é‡è¤‡</span>\n    len<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span> æœ‰é‡è¤‡å°‡ len <span class=\"token operator\">+</span><span class=\"token number\">1</span> å¾Œå†ç”¢ç”Ÿæ–°çš„\n    s <span class=\"token operator\">=</span> <span class=\"token function\">getRandomString</span><span class=\"token punctuation\">(</span>len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">await</span> env<span class=\"token punctuation\">.</span><span class=\"token constant\">URLS</span><span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­˜å…¥ kv</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Response</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">f00</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">msg</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Response</span><span class=\"token punctuation\">(</span>msg <span class=\"token operator\">?</span> msg <span class=\"token operator\">:</span> <span class=\"token string\">\"BAD REQUEST\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">status</span><span class=\"token operator\">:</span> <span class=\"token number\">400</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">isValidHttpUrl</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> url<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    url <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URL</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> url<span class=\"token punctuation\">.</span>protocol <span class=\"token operator\">===</span> <span class=\"token string\">\"http:\"</span> <span class=\"token operator\">||</span> url<span class=\"token punctuation\">.</span>protocol <span class=\"token operator\">===</span> <span class=\"token string\">\"https:\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">getRandomString</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">len</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> s <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> len<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    s <span class=\"token operator\">+=</span> String<span class=\"token punctuation\">.</span><span class=\"token function\">fromCharCode</span><span class=\"token punctuation\">(</span><span class=\"token function\">getRandomInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">26</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">97</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> s<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>é€™å€‹ POST è¦åƒä¸€å€‹åƒæ˜¯ä¸‹é¢çš„ json bodyï¼Œåˆ†åˆ¥æœ‰è¦ç¸®çš„ç¶²å€ï¼Œå’Œè¦ç”¢å‡ºçš„çŸ­ç¶²å€é•·åº¦ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"url\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://tonypepe.com\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"len\"</span><span class=\"token operator\">:</span> <span class=\"token number\">3</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>å¯ä»¥ç™¼ç¾æˆ‘å€‘æ˜¯æ²’æœ‰åšæ¬Šé™æª¢æŸ¥çš„ï¼Œæ‰€ä»¥ä»»ä½•äººåªè¦å° POST <code class=\"language-text\">/new</code>ï¼Œéƒ½å¯ä»¥ç”¢ç”Ÿæ–°çš„çŸ­ç¶²å€ï¼Œä½†æˆ‘è‡ªå·±æ˜¯è¦ºå¾—å•é¡Œä¹Ÿä¸å¤§ï¼Œç•¢ç«Ÿ Cloudflare å°±æ˜¯ä¸€å®¶ ddos é˜²è­·å•†ï¼Œæ‰€ä»¥è¦è¢«æ”»æ“Šåˆ°ä¸€å¤©çš„ä½¿ç”¨é‡éƒ½ç”¨å®Œæ‡‰è©²ä¹Ÿå¾ˆé›£ã€‚æˆ–æ˜¯ä½ æƒ³è¦åšæ¬Šé™æª¢æŸ¥ï¼Œä¹Ÿå¯ä»¥è©¦è‘—å¯¦ä½œçœ‹çœ‹ã€‚</p>\n<h2>Redirect é‡æ–°å°å‘</h2>\n<p>æœ€å¾Œä¸€æ­¥å°±æ˜¯æŠŠçŸ­ç¶²å€é‡æ–°å°å‘åˆ°åŸæœ¬çš„ç¶²å€ï¼Œé€™éƒ¨ä»½å¾ˆç°¡å–®ï¼Œå°±æ˜¯å¾ kv å–å¾—åŸæœ¬çš„ç¶²å€ï¼Œç„¶å¾Œ Response HTTP 303 ä¾†åšé‡æ–°å°å‘ï¼Œå–ä¸åˆ° value å°±çµ¦ 404ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">router<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/:path\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> env</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> params <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> req<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> env<span class=\"token punctuation\">.</span><span class=\"token constant\">URLS</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>url <span class=\"token operator\">==</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Response</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"NOT FOUND\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">status</span><span class=\"token operator\">:</span> <span class=\"token number\">404</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Response</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">status</span><span class=\"token operator\">:</span> <span class=\"token number\">303</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  response<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Location\"</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Publish</h2>\n<p><code class=\"language-text\">wrangler publish</code> å°±å¯ä»¥æŠŠç¨‹å¼ç¢¼éƒ¨ç½²åˆ°å…¨çƒçš„ Cloudflare ç¯€é»ï¼Œå¦‚æœæ²’æœ‰è‡ªå·±ç¶²åŸŸï¼ŒCloudflare ä¹Ÿæœƒçµ¦ä½ ä¸€å€‹ <code class=\"language-text\">xxx.workers.dev</code> çš„ç¶²åŸŸå…è²»ä½¿ç”¨ï¼Œå¯ä»¥ç¾åœ¨é€™è£¡æ¸¬è©¦çœ‹çœ‹ï¼Œå†æ±ºå®šè¦ä¸è¦æŠŠè‡ªå·±çš„ç¶²åŸŸç¶å®šä¸Šå»ã€‚</p>\n<h2>å¾Œè¨˜</h2>\n<p>é€™ç¯‡ç”¨ä¸åˆ° 100 è¡Œç¨‹å¼ç¢¼ç†Ÿç·´äº† Cloudflare çš„ Serverless æœå‹™ï¼Œå’Œå¯«å‡ºäº†çŸ­ç¶²å€æ‡‰ç”¨ï¼Œè®“æˆ‘å€‘ä¸ç”¨è‡ªå·±æ¶è¨­è‡ªå·±çš„ Server å°±å¯ä»¥æœ‰å‹•æ…‹ç¶²é çš„åŠŸèƒ½ã€‚æˆ‘é‚„çœ‹åˆ°å®˜æ–¹çš„æ–‡ä»¶ä¸­å¯ä»¥æŠŠ Response åŠ ä¸Š Cors çš„æ¨™é ­ï¼Œè®“åŸæœ¬ä¸å…è¨±è·¨ç«™å­˜å–çš„ api å¯ä»¥è·¨ç«™å­˜å–ï¼Œé›–ç„¶å¾ˆä¸é“å¾·ï¼Œä½†æ˜¯æˆ‘å–œæ­¡ã€‚æˆ‘è‡ªå·±é‚„æƒ³åˆ°å¯ä»¥å°åŸæœ¬çš„éœæ…‹ç¶²é åŠ ä¸Šé™åˆ¶å­˜å–çš„åŠŸèƒ½ï¼Œæˆ–æ˜¯ç¶²é æœ‰èª¤ç›´æ¥æŠŠç¶²é å…ˆå°å‘ 404ï¼Œé€™éƒ½æ˜¯å¾ˆæœ‰è¶£çš„æ‡‰ç”¨ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±ç™¼æ®çœ‹çœ‹ã€‚</p>\n<p>å¦‚æœè¦å®Œæ•´ç¨‹å¼ç¢¼ï¼š<a href=\"https://gist.github.com/TonyPepeBear/f435dae11b83fc2626a49a6b3cc9848b\">Gist</a></p>\n<h2>Reference</h2>\n<ul>\n<li><a href=\"https://developers.cloudflare.com/workers/\">Cloudflare Workers documentation</a></li>\n</ul>","rawMarkdownBody":"\nCloudflare Workers ä¹Ÿæ˜¯ Cloudflare çš„ä½›å¿ƒæœå‹™ä¹‹ä¸€ï¼Œå¯ä»¥æŠŠ node ç¨‹å¼éƒ¨ç½²åˆ° Cloudflare ä¸Šçš„çœ¾å¤šç¯€é»ï¼Œæ•ˆèƒ½ä¹Ÿä¸ä¿—ï¼Œæ¯å¤©é‚„æœ‰ 100,000 æ¬¡çš„å…è²»å‘¼å«ï¼Œä¹Ÿæ²’æœ‰å†·å•Ÿå‹•çš„å•é¡Œï¼Œå°æµé‡ä¸é«˜çš„ç¶²é ä¾†èªªå®Œå…¨å¤ ç”¨ã€‚å¦å¤–ï¼Œé‚„æœ‰ Workers KV å¯ä»¥ç”¨ä¾†å„²å­˜è³‡æ–™ï¼Œé€™å°±å¯ä»¥å¯«å‡ºç°¡å–®çš„å‹•æ…‹ç¶²é ï¼Œç”šè‡³æ˜¯ä¸€äº›æ›´è¤‡é›œçš„æ‡‰ç”¨ã€‚ä»Šå¤©å°±ä¾†å¯«ä¸€å€‹ Serverless çš„çŸ­ç¶²å€æœå‹™ï¼Œä¸¦æŠŠè³‡æ–™å­˜åœ¨ KV ä¸­ï¼Œå°±æˆ‘ç›®å‰è‡ªå·±æ¸¬è©¦ä¸‹ä¾†ï¼ŒWorkers çš„æ•ˆç‡çœŸçš„æ²’è©±èªªã€‚\n\n<!--more-->\n\n## Workers Playground\n\nå¦‚æœæƒ³è¦åœ¨ç¶²é ä¸­å…ˆè©¦è©¦çœ‹ Workersï¼Œå¯ä»¥åˆ° [Cloudflare Workers](https://cloudflareworkers.com/) é€™å€‹ç¶²ç«™ã€‚\n\næœƒæœ‰ä¸€å€‹é è¨­çš„æ¨¡æ¿é•·é€™æ¨£ï¼š\n\n```js\naddEventListener(\"fetch\", (event) => {\n  event.respondWith(handleRequest(event.request));\n});\n\n/**\n * Fetch and log a given request object\n * @param {Request} request\n */\nasync function handleRequest(request) {\n  console.log(\"Got request\", request);\n  const response = await fetch(request);\n  console.log(\"Got response\", response);\n  return response;\n}\n```\n\nè®“æˆ‘å€‘å…ˆä¾†ç†è§£ä¸€ä¸‹ç¨‹å¼ç¢¼ã€‚\n\nå¯ä»¥çœ‹åˆ°ç¨‹å¼æœ‰å…©å€‹ functionï¼Œå…¶ä¸­ `addEventListener(...)` å°±æ˜¯ç¨‹å¼çš„å…¥å£ï¼Œç•¶ Workers æ”¶åˆ° Request ä¹‹å¾Œï¼Œå°±æœƒå‚³å…¥ä½ çµ¦ä»–çš„ functionï¼Œç„¶å¾Œå†æ±ºå®šè¦ç”¨ä»€éº¼ Response å›å‚³åˆ° Clientï¼Œé€™è£¡ä»–å¯«äº†ä¸€å€‹ `handleRequest` çš„ function ä¾†è™•ç†ã€‚æ‰€ä»¥é€™å€‹ç¨‹å¼ç¢¼å¯¦éš›ä¸Šåšçš„äº‹ï¼Œå°±åªæœ‰æŠŠ Request å’Œ Response çµ¦ log å‡ºä¾†ï¼Œå›å‚³åŸæœ¬çš„ç¶²é çš„æ¨£å­ä¸åšä»»ä½•æ›´å‹•ã€‚\n\nä¸‹åœ–æ˜¯ Workers åœ¨ Cloudflare ä¸Šçš„é‹è¡Œé †åºï¼Œå¯ä»¥çœ‹åˆ° Workers è¢«æ”¾åœ¨æœ€å¾Œä¸€å€‹ï¼Œä¹Ÿå°±æ˜¯æœ€å¾Œä¸€å€‹æ±ºå®šè¦å›å‚³ä»€éº¼å…§å®¹çµ¦ User çš„åœ°æ–¹ï¼Œä¹Ÿå¯ä»¥ç†è§£ç‚ºå¯ä»¥åœ¨é€™è£¡å°åŸæœ¬çš„ Response åšæœ€å¾Œçš„æ›´å‹•ï¼Œå†å›å‚³çµ¦ Clientã€‚\n\næ‰€ä»¥é€™å€‹ Playground ä¸Šå¯ä»¥è¼¸å…¥ä»»æ„çš„ URLï¼Œä¾†é è¦½ä½ çš„ Workers åœ¨ä»»ä½•ä¸€å€‹ç¶²ç«™ä¸Šï¼Œæœƒå° Response åšçš„æ›´å‹•ã€‚\n\n![img](https://imagedelivery.net/cdkaXPuFls5qlrh3GM4hfA/32bd1508-ba78-4e94-76a0-adec503fe000/public)\n\nä¹Ÿå°±æ˜¯èªªå¦‚æœæŠŠç¨‹å¼æ”¹æˆä¸‹é¢é€™æ¨£ï¼Œå°±å¯ä»¥ç™¼ç¾ä»»æ„ç¶²ç«™éƒ½æœƒè®Šæˆ Google çš„æ¨¡æ¨£ã€‚\n\n```js\naddEventListener(\"fetch\", (event) => {\n  event.respondWith(handleRequest(event.request));\n});\n\nasync function handleRequest(request) {\n  const response = await fetch(\"https://google.com\");\n  return response;\n}\n```\n\n![img](https://imagedelivery.net/cdkaXPuFls5qlrh3GM4hfA/d7409a8b-8203-4e23-6491-309a4cc5b500/public)\n\nç†è§£å¾Œå°±æœƒç™¼ç¾ï¼Œå…¶å¯¦ Workers å¯ä»¥å°ç¶²é æœ‰å³æ™‚æ€§çš„æ›´æ”¹ï¼Œä¹Ÿå°±æ˜¯èªªå¯ä»¥å°ç¾æœ‰çš„ç¶²é åŠ ä¸Šæ–°åŠŸèƒ½ï¼Œæˆ–æ˜¯åœ¨ä¸æ›´å‹•åŸæœ¬ç¶²é çš„æƒ…æ³ä¸‹å»ä¿® bugã€‚\n\n## Wrangler\n\nWrangler æ˜¯ç®¡ç† Workers æœƒç”¨åˆ°çš„ cli å·¥å…·ï¼Œé›–ç„¶ä¸å®‰è£ä¹Ÿæ˜¯å¯ä»¥åœ¨ç¶²é ä¸­æ’°å¯« Workers ï¼Œä½†æ˜¯åŠŸèƒ½å°±æœƒå°‘å¾ˆå¤šï¼Œæ‰€ä»¥é‚„æ˜¯å»ºè­°å®‰è£ä¸€ä¸‹ã€‚é€™è£¡æ˜¯å®˜æ–¹çš„ Repo [cloudflare/wrangler2](https://github.com/cloudflare/wrangler2)ã€‚\n\nç”¨ npm å®‰è£åˆ° Globalï¼š\n\n```bash\nnpm i @cloudflare/wrangler -g\n```\n\né‚„æ˜¯å»ºè­°å»å®˜æ–¹ Repo çœ‹ä¸‹æœ‰æ²’æœ‰å…¶ä»–æ³¨æ„äº‹é …\n\nå®‰è£å®Œæˆå¾Œè¦ç™»å…¥ Cloudflare å¸³è™Ÿï¼Œ`wrangler login`ï¼Œå†ç”¨ç€è¦½å™¨ç™»å…¥å³å¯ã€‚\n\n## Init Project\n\n`wrangler init <project-name>` å‰µå»ºæ–°çš„å°ˆæ¡ˆï¼Œé€™ç•¶ä¸­ Wrangler æœƒå•ä¸€äº›å•é¡Œï¼Œå¯ä»¥æŒ‰ç…§è‡ªå·±çš„éœ€æ±‚æ±ºå®šã€‚\n\ninit å®Œæˆå¾Œï¼Œå¯ä»¥çœ‹åˆ°è‡ªå‹•ç”¢ç”Ÿäº†ä¸€äº›æª”æ¡ˆï¼ŒåŸºæœ¬ä¸Šæœƒç”¨åˆ°çš„åªæœ‰ `wrangler.toml` å’Œ `index.js` å…©å€‹æª”æ¡ˆã€‚\n\nç¾åœ¨å¯ä»¥å…ˆåœ¨ Terminal ä¸­è¼¸å…¥ `wrangler dev`ï¼Œå°±å¯ä»¥è®“ Workers è·‘åœ¨æœ¬åœ°ã€‚\n\n### Bug\n\nå› ç‚ºæˆ‘çš„ Cloudflare ä¸€æ¬¡ç™»å…¥å¤šå€‹ Userï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ wrangler çš„ **2.0.14** æ™‚å€™æœƒå‡º bug ç›´æ¥é–ƒé€€ï¼Œæˆ‘è§£æ±ºçš„æ–¹å¼æ˜¯ç›´æ¥åœ¨ `wrangler.toml` ä¸­è¼¸å…¥ `account_id` ä¾†é¿å… wrangler æœƒéœ€è¦é¸æ“‡å¸³è™Ÿçš„å•é¡Œã€‚\n\n```toml\naccount_id = \"xxxxxxxxxxxxxxx\"\n```\n\n## Cloudflare Workers KV\n\nçœ‹åˆ°åå­—å–ä½œ KVï¼Œç›´è§€çš„å°±æ˜¯è¡¨ç¤º `key-value` éµå€¼å°ï¼Œç¼ºé»æ˜¯ Key åªèƒ½å°ä¸Šä¸€å€‹ Valueï¼Œä¸èƒ½è¦å·¢ç‹€çš„ Value (åƒæ˜¯ Json é‚£æ¨£)ï¼Œè§£æ±ºçš„æ–¹å¼å…¶å¯¦ä¹Ÿæ˜¯ä¸é›£ï¼Œå¯ä»¥ç›´æ¥åœ¨ Value ä¸­å­˜ä¸Šæ•´çš„ Json æª”æ¡ˆï¼Œä½†åœ¨æœ¬æ–‡ä¸æœƒå¤šåšèªªæ˜ï¼Œå¯ä»¥è‡ªå·±ç ”ç©¶çœ‹çœ‹ã€‚\n\nå¦å¤– Cloudflare ä¹Ÿæœ‰æåˆ°ï¼ŒKV å­˜å–åœ¨å…¨çƒå¯èƒ½ä¸æ˜¯å³æ™‚æ€§çš„ï¼Œå¥½åƒæ˜¯åªä¿è­‰ 60 ç§’å¾ŒæœƒåŒæ­¥åˆ°æ‰€æœ‰ Serverï¼Œé›–ç„¶æˆ‘è¦ºå¾—æœ€æ…¢æ‡‰è©²ä¹Ÿæ˜¯ 5 å…§ç§’å•¦ï¼Œæˆ‘å¾ä¾†æ²’æœ‰æ„Ÿå—åˆ°å»¶é²éï¼Œä½†å¦‚æœå°å³æ™‚æ€§æœ‰ç–‘æ…®çš„å°ˆæ¡ˆå¯èƒ½ä¹Ÿè¦æ³¨æ„ä¸€ä¸‹ã€‚\n\nä¸‹é¢å°±ä¾†å‰µå»ºä¸€å€‹ KV namespaceï¼Œé€™å°±æ˜¯ä¸€å€‹ Database çš„åŸºæœ¬å–®ä½ï¼Œç›®å‰ Cloudflare æ˜¯å…è¨±ä¸€å€‹å¸³è™Ÿæœ‰ 100 å€‹ KV namespaceï¼Œæ‰€ä»¥æ­£å¸¸ä¾†èªªæ‡‰è©²ä¹Ÿä¸ç”¨æ“”å¿ƒæœƒç”¨å®Œã€‚ä¸‹é¢ç”¨ `URLS` ç•¶ä½œ namespace çš„åç¨±ï¼Œå› ç‚ºæˆ‘å€‘æ˜¯è¦å­˜çŸ­ç¶²å€çš„è³‡æ–™ã€‚\n\n```bash\n$ wrangler kv:namespace create \"URLS\"\n\nğŸŒ€  Creating namespace with title \"my-site-MY_KV\"\nâœ¨  Success!\nAdd the following to your configuration file:\nkv_namespaces = [\n  { binding = \"URLS\", id = \"xxxxxxxxxxxxxxxxxxxxxxx\" }\n]\n```\n\nç„¶å¾Œ wrangler æœƒæœ‰å€‹çµ¦ä½ ä¸€å€‹ binding å’Œ idï¼Œå°±ç›´æ¥è¤‡è£½è²¼ä¸Šåˆ° `wrangler.tmol` ä¸­å³å¯ï¼š\n\n```toml\nkv_namespaces = [\n  { binding = \"URLS\", id = \"xxxxxxxxxxxxxxxxxxxxxxx\" }\n]\n```\n\nå¦‚æœè¦åœ¨ wrangler çš„ dev æ¨¡å¼ä¸­æ¸¬è©¦ KVï¼Œå°±å¤šç”³è«‹ä¸€å€‹ Preview KVï¼Œä¾†é¿å…å°å·²ç¶“ä¸Šç·šçš„æœå‹™é€ æˆå½±éŸ¿ï¼š\n\n```bash\n$ wrangler kv:namespace create \"URLS\" --preview\n\nâ›…ï¸ wrangler 2.0.14\n--------------------\nğŸŒ€ Creating namespace with title \"URLS\"\nâœ¨ Success!\nAdd the following to your configuration file in your kv_namespaces array:\n{ binding = \"URLS\", preview_id = \"xxxxxxxxxxxxxxxxxxxx2\" }\n```\n\né€™æ¬¡æŠŠ `preview_id` å®¶åœ¨åŸæœ¬çš„ id å¾Œæ–¹å³å¯ï¼š\n\n```toml\nkv_namespaces = [\n    { binding = \"URLS\", id = \"xxxxxxxxxxxxxxxxxxxx\", preview_id = \"xxxxxxxxxxxxxxxxxxxx2\" }\n]\n```\n\nè¨­å®šå¥½å¾Œï¼Œwrangler æœƒç›´æ¥æŠŠä½ å‰›å‰›å–çš„åå­—ç›´æ¥ç”¨ç’°å¢ƒè®Šæ•¸ (ENV) å‚³å…¥ï¼Œå…·é«”çš„ä½¿ç”¨æ–¹å¼å¯ä»¥ç¹¼çºŒå¾€ä¸‹çœ‹ã€‚\n\n## Routing\n\nç‚ºäº†æ–¹ä¾¿ç­‰ç­‰æˆ‘å€‘è™•ç†å‚³å…¥çš„ Routingï¼Œæˆ‘å€‘å…ˆä¾†å®‰è£ä¸€å€‹ npm å¥—ä»¶ã€‚å°ä½ æ²’çœ‹éŒ¯ï¼ŒWorkers ä¹Ÿæ˜¯æ”¯æ´ npm å¥—ä»¶çš„ï¼š\n\n```bash\nyarn add itty-router\n\nnpm i itty-router\n```\n\né€™æ¨£ç­‰ç­‰å°±å¯ä»¥ç”¨ itty-router ä¾†è™•ç†å‚³å…¥çš„ requestã€‚\n\næˆ‘å€‘å…ˆå°‡ Handle Request å®Œå…¨ä¸Ÿçµ¦çš„ itty-router ä¾†è™•ç†ï¼Œå°‡ index.js æ”¹æˆä¸‹æ–¹é€™æ¨£ï¼š\n\n```js\nimport { Router } from \"itty-router\";\n\nconst router = Router();\n\nexport default {\n  fetch: router.handle,\n};\n```\n\nå¯ä»¥çœ‹åˆ°ç›´æ¥ export router çš„ handle æ–¹æ³•ï¼Œé€™æ¨£å°±å®Œå…¨æŠŠ Requse äº¤çµ¦ Router ä¾†è™•ç†ã€‚æˆ‘å€‘å…ˆå°‡ root å›å‚³ Hello æ¸¬è©¦çœ‹çœ‹ï¼š\n\n```js\nimport { Router } from \"itty-router\";\n\nconst router = Router();\n\nrouter.get(\"/\", async (req, env) => {\n  return new Response(\"Hello Workers\", {\n    status: 200,\n  });\n});\n\nexport default {\n  fetch: router.handle,\n};\n```\n\nç¾åœ¨å¯ä»¥ `wrangler dev` ä¸€ä¸‹ï¼Œç„¶å¾Œåˆ° `loclahost:8787/` çœ‹çœ‹æœƒä¸æœƒå›å‚³ Hello Workersã€‚\n\n> ä¹‹å¾Œçš„ç¨‹å¼ç¢¼å°±ä¸å†å®Œæ•´çš„å¯«å‡ºä¾†äº†ï¼Œä½†å°±æ˜¯åœ¨é€™å€‹å¤§æ¡†æ¶ä¸‹æ’°å¯«\n\n### New çŸ­ç¶²å€\n\næˆ‘å€‘å¯«ä¸€å€‹ post æ–¹æ³•ä¾†æ¥æ”¶æ–°çš„ç¶²å€ï¼Œä¸¦å›å‚³ä»–çš„æ–°çŸ­ç¶²å€çµ¦ä»–ã€‚\n\n```js\nrouter.post(\"/new\", async (req, env) => {\n  const body = await req.json();        // å–å¾— POST JSON BODY ä¸¦è½‰æˆ JS ç‰©ä»¶\n  console.log(JSON.stringify(body));\n  var { url, len } = body;\n  if (url == undefined) return f00(\"\"); // JSON æœ‰èª¤ï¼Œå›å‚³ 400 éŒ¯èª¤\n  if (!isValidHttpUrl(url)) return f00(\"URL is not valid\");  // ç¢ºèªæ˜¯å¦ç‚º Http ç¶²å€\n  if (len == undefined) len = 5;\n  if (len < 4) return f00(\"Lenght must be at least 4\"); // ç¢ºèªè‡³å°‘å¤§æ–¼ç­‰æ–¼ 4\n  var s = getRandomString(len); // ç”¢ç”Ÿè‹±æ–‡äº‚ç¢¼\n  while ((await env.URLS.get(s)) != undefined) { // å¾ kv ç¢ºèªæ²’æœ‰é‡è¤‡\n    len++; æœ‰é‡è¤‡å°‡ len +1 å¾Œå†ç”¢ç”Ÿæ–°çš„\n    s = getRandomString(len);\n  }\n  await env.URLS.put(s, url); // å­˜å…¥ kv\n  return new Response(s);\n});\n\nconst f00 = (msg) => new Response(msg ? msg : \"BAD REQUEST\", { status: 400 });\n\nfunction isValidHttpUrl(string) {\n  let url;\n  try {\n    url = new URL(string);\n  } catch (_) {\n    return false;\n  }\n  return url.protocol === \"http:\" || url.protocol === \"https:\";\n}\n\nfunction getRandomString(len) {\n  var s = \"\";\n  for (let i = 0; i < len; i++) {\n    s += String.fromCharCode(getRandomInt(26) + 97);\n  }\n  return s;\n}\n```\n\né€™å€‹ POST è¦åƒä¸€å€‹åƒæ˜¯ä¸‹é¢çš„ json bodyï¼Œåˆ†åˆ¥æœ‰è¦ç¸®çš„ç¶²å€ï¼Œå’Œè¦ç”¢å‡ºçš„çŸ­ç¶²å€é•·åº¦ï¼š\n\n```json\n{\n  \"url\": \"https://tonypepe.com\",\n  \"len\": 3\n}\n```\n\nå¯ä»¥ç™¼ç¾æˆ‘å€‘æ˜¯æ²’æœ‰åšæ¬Šé™æª¢æŸ¥çš„ï¼Œæ‰€ä»¥ä»»ä½•äººåªè¦å° POST `/new`ï¼Œéƒ½å¯ä»¥ç”¢ç”Ÿæ–°çš„çŸ­ç¶²å€ï¼Œä½†æˆ‘è‡ªå·±æ˜¯è¦ºå¾—å•é¡Œä¹Ÿä¸å¤§ï¼Œç•¢ç«Ÿ Cloudflare å°±æ˜¯ä¸€å®¶ ddos é˜²è­·å•†ï¼Œæ‰€ä»¥è¦è¢«æ”»æ“Šåˆ°ä¸€å¤©çš„ä½¿ç”¨é‡éƒ½ç”¨å®Œæ‡‰è©²ä¹Ÿå¾ˆé›£ã€‚æˆ–æ˜¯ä½ æƒ³è¦åšæ¬Šé™æª¢æŸ¥ï¼Œä¹Ÿå¯ä»¥è©¦è‘—å¯¦ä½œçœ‹çœ‹ã€‚\n\n## Redirect é‡æ–°å°å‘\n\næœ€å¾Œä¸€æ­¥å°±æ˜¯æŠŠçŸ­ç¶²å€é‡æ–°å°å‘åˆ°åŸæœ¬çš„ç¶²å€ï¼Œé€™éƒ¨ä»½å¾ˆç°¡å–®ï¼Œå°±æ˜¯å¾ kv å–å¾—åŸæœ¬çš„ç¶²å€ï¼Œç„¶å¾Œ Response HTTP 303 ä¾†åšé‡æ–°å°å‘ï¼Œå–ä¸åˆ° value å°±çµ¦ 404ã€‚\n\n```js\nrouter.get(\"/:path\", async (req, env) => {\n  const { params } = req;\n  const url = await env.URLS.get(params.path.toLowerCase());\n  if (url == undefined) return new Response(\"NOT FOUND\", { status: 404 });\n  const response = new Response(\"\", { status: 303 });\n  response.headers.append(\"Location\", url);\n  return response;\n});\n```\n\n## Publish\n\n`wrangler publish` å°±å¯ä»¥æŠŠç¨‹å¼ç¢¼éƒ¨ç½²åˆ°å…¨çƒçš„ Cloudflare ç¯€é»ï¼Œå¦‚æœæ²’æœ‰è‡ªå·±ç¶²åŸŸï¼ŒCloudflare ä¹Ÿæœƒçµ¦ä½ ä¸€å€‹ `xxx.workers.dev` çš„ç¶²åŸŸå…è²»ä½¿ç”¨ï¼Œå¯ä»¥ç¾åœ¨é€™è£¡æ¸¬è©¦çœ‹çœ‹ï¼Œå†æ±ºå®šè¦ä¸è¦æŠŠè‡ªå·±çš„ç¶²åŸŸç¶å®šä¸Šå»ã€‚\n\n## å¾Œè¨˜\n\né€™ç¯‡ç”¨ä¸åˆ° 100 è¡Œç¨‹å¼ç¢¼ç†Ÿç·´äº† Cloudflare çš„ Serverless æœå‹™ï¼Œå’Œå¯«å‡ºäº†çŸ­ç¶²å€æ‡‰ç”¨ï¼Œè®“æˆ‘å€‘ä¸ç”¨è‡ªå·±æ¶è¨­è‡ªå·±çš„ Server å°±å¯ä»¥æœ‰å‹•æ…‹ç¶²é çš„åŠŸèƒ½ã€‚æˆ‘é‚„çœ‹åˆ°å®˜æ–¹çš„æ–‡ä»¶ä¸­å¯ä»¥æŠŠ Response åŠ ä¸Š Cors çš„æ¨™é ­ï¼Œè®“åŸæœ¬ä¸å…è¨±è·¨ç«™å­˜å–çš„ api å¯ä»¥è·¨ç«™å­˜å–ï¼Œé›–ç„¶å¾ˆä¸é“å¾·ï¼Œä½†æ˜¯æˆ‘å–œæ­¡ã€‚æˆ‘è‡ªå·±é‚„æƒ³åˆ°å¯ä»¥å°åŸæœ¬çš„éœæ…‹ç¶²é åŠ ä¸Šé™åˆ¶å­˜å–çš„åŠŸèƒ½ï¼Œæˆ–æ˜¯ç¶²é æœ‰èª¤ç›´æ¥æŠŠç¶²é å…ˆå°å‘ 404ï¼Œé€™éƒ½æ˜¯å¾ˆæœ‰è¶£çš„æ‡‰ç”¨ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±ç™¼æ®çœ‹çœ‹ã€‚\n\nå¦‚æœè¦å®Œæ•´ç¨‹å¼ç¢¼ï¼š[Gist](https://gist.github.com/TonyPepeBear/f435dae11b83fc2626a49a6b3cc9848b)\n\n## Reference\n\n- [Cloudflare Workers documentation](https://developers.cloudflare.com/workers/)\n","excerpt":"Cloudflare Workers ä¹Ÿæ˜¯ Cloudflare çš„ä½›å¿ƒæœå‹™ä¹‹ä¸€ï¼Œå¯ä»¥æŠŠ node ç¨‹å¼éƒ¨ç½²åˆ° Cloudflare ä¸Šçš„çœ¾å¤šç¯€é»ï¼Œæ•ˆèƒ½ä¹Ÿä¸ä¿—ï¼Œæ¯å¤©é‚„æœ‰ 100,000 æ¬¡çš„å…è²»å‘¼å«ï¼Œä¹Ÿæ²’æœ‰å†·å•Ÿå‹•çš„å•é¡Œï¼Œå°æµé‡ä¸é«˜çš„ç¶²é ä¾†èªªå®Œå…¨å¤ ç”¨ã€‚å¦å¤–ï¼Œé‚„æœ‰ Workers KV å¯ä»¥ç”¨ä¾†å„²å­˜è³‡æ–™ï¼Œé€™å°±å¯ä»¥å¯«å‡ºç°¡å–®çš„å‹•æ…‹ç¶²é ï¼Œç”šè‡³æ˜¯ä¸€äº›æ›´è¤‡é›œçš„æ‡‰ç”¨ã€‚ä»Šå¤©å°±ä¾†å¯«ä¸€å€‹ Serverless çš„çŸ­ç¶²â€¦","frontmatter":{"title":"ç”¨ Cloudflare Workers æ¶è¨­ Serverless çŸ­ç¶²å€æœå‹™","date":"2022-06-21T09:15:49.000Z","draft":false,"tags":["cloudflare","workers","worker","web","short","url"],"image":"https://imagedelivery.net/cdkaXPuFls5qlrh3GM4hfA/b6cf9d30-1028-4aa5-c136-0dbc6c098f00/public","description":null}}}]}},"pageContext":{"id":"550f8597-f4a8-5fe3-a7ca-f1392da79702"}},"staticQueryHashes":[]}